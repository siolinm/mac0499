%!TeX root=./par.tex

\FloatBarrier
\section{Algoritmo Cinético}

Para ``cinetizar'' o algoritmo estático utilizaremos certificados,
para assegurar que as nossas estruturas permanecerão corretas.
Primeiramente, teremos os certificados das três \textit{listas
ordenadas cinéticas}, seção \ref{lista:secao}, que guardarão a ordem
dos pontos de acordo com os eixos $x$, $x + 60^\circ$ e $x -
60^\circ$.

Para garantir qual, dentre os pares $(p, \lcand(p))$, é o par mais
próximo usaremos um \textit{torneio cinético com inserção e
remoção}, seção \ref{trni:secao}, com respeito ao mínimo em vez de
ao máximo. Temos um total de $3n$ pares, pois consideraremos também
os pares $(p, \lcand(p))$ em que $\lcand(p)$ é nulo e os
certificados destes serão $+\infty$.

Também precisaremos manter informação guardada para atualizar com
eficiência mudanças provocadas por trocas na ordem dos pontos em
relação a um dos três eixos. Por exemplo, uma troca na ordem dos
pontos pode acarretar na mudança nos conjuntos $\Cands(p)$ e
$\Cands(q)$. Mudanças nesses conjuntos ocorrerão quando $q =
\up(p)$, $q = \low(p)$ ou $q \in \Cands(p)$. Portanto, para que
consigamos manter $\lcand(p)$ de maneira eficiente cada ponto terá
três árvores binárias de busca associadas a ele com os conjuntos
$\Cands(p)$, $\Hits_{up}(p)$ e $\Hits_{low}(p)$. A árvore
$\Cands(p)$ guarda os pontos que pertencem ao conjunto $\Cands(p)$
ordenados pela coordenada $y$. A árvore $\Hits_{up}(p)$ guarda os
pontos $q$ tais que $\up(q) = p$, ordenados pela coordenada $x$.
Similarmente, a árvore $\Hits_{low}(p)$ guarda os pontos $q$ tais
que $\low(q) = p$, ordenados pela coordenada $x$. Utilizaremos uma
árvore $\Cands(p)$, $\Hits_{up}(p)$ e $\Hits_{low}(p)$ para cada um
dos eixos, logo, para cada ponto $p$, haverão nove \textit{splay
trees} no total.

Cada uma das três árvores têm sua raiz apontando para o nó $p$, e
cada nó das árvores aponta para o seu nó pai. Na árvore $\Cands(p)$
cada nó deve apontar para o descendente que contém o ponto mais à
esquerda na ordenação horizontal. Na nossa implementação as árvores
serão \textit{splay trees}. Essas estruturas contém toda a
informação necessária para que mantenhamos nossas estruturas
atualizadas e, consequentemente, o par mais próximo do conjunto.

Na implementação do algoritmo inicialmente inserimos os pontos nas
três listas ordenadas. Uma vez que as listas estejam montadas,
percorremos os pontos da direita para a esquerda preenchendo as
estruturas $\Cands(p)$, $\Hits_{up}(p)$ e $\Hits_{low}(p)$ para cada
ponto $p$ e para cada um dos eixos. Esta etapa é feita da mesma
forma que foi apresentada na seção sobre o algoritmo estático.

A medida que as estruturas $\Cands(p)$ são inicializadas inserimos o
par $(p, \lcand(p))$ no torneio. Quando todos os pares forem
inseridos no torneio realizamos as partidas e calculamos os
certificados, o par $(p, q)$ da partida que possuir menor distância
é considerado o vencedor.

Todos os certificados são colocados em uma fila de prioridade $Q$.
Os certificados inseridos na fila possuem quatro informações:
\begin{itemize}
    \item $t~\rightarrow$ instante de tempo em que o certificado
    expira. É utilizado como chave para a fila de prioridade.
    Desempates são tratados de maneira especial e serão explicados
    mais adiante;
    \item $p~\rightarrow$ um dos pontos envolvidos no evento
    representado pelo certificado. Caso seja um certificado de troca
    na ordenação, $p$ é o ponto mais a direita naquela ordenação;
    \item $q~\rightarrow$ o outro ponto envolvido no evento
    representado pelo certificado. Caso seja um certificado de troca
    na ordenação, $q$ é o ponto mais a esquerda naquela ordenação;
    \item tipo $ \rightarrow$ o tipo de evento que o certificado
    representa. Pode representar uma troca em uma das três
    ordenações, denominadas por \textit{H} (horizontal =
    $0^\circ$-ordem), \textit{U} (up = $+60^\circ$-ordem) e
    \textit{D} (down = $-60^\circ$-ordem) ou pode representar a
    vitória do par $(p, q)$ em uma partida do torneio.
\end{itemize}
% Falar sobre a chave e fazer o gancho para os casos degenerados. Terminar
% os pseudocódigos e se possível melhorar as subfiles.

Vamos agora falar de um evento em que ocorre uma mudança na ordem
horizontal. No primeiro caso, $p$ se encontra à esquerda e abaixo de
$q$, veja a figura \ref{fig:parcinetico:eventohorizontalabaixo}. O
caso em que $q$ está à esquerda de $p$ será tratado de maneira
parecida. O algoritmo \ref{parcinetico:eventohorizontal} implementa
a sequência de operações referentes à esse tipo de evento.

\begin{figure}[h]
    \centering
    \begin{tikzpicture}[thick, scale=0.4]
        \node[label={[label distance = -3mm]160:$p$}] at
            (2.00, 2.00) {\textbullet};
        \node[label={[label distance = -3mm]160:$q$}] at
            (3.00, 5.00) {\textbullet};
        \node[label={[label distance = -2mm]90:$a = t$}] at
            (6.00, 5.00) {\textbullet};
        \node[label={[label distance = -3mm]160:$b$}] at
            (8.00, 3.00) {\textbullet};
        \node[label={[label distance = -3mm]160:$c = w$}] at
            (7.00, 1.00) {\textbullet};
        \node[label={[label distance = -3mm]160:$d$}] at
            (9.00, -1.00) {\textbullet};
        \node[label={[label distance = -3mm]160:$e$}] at
            (5.00, 8.00) {\textbullet};
        \node[label={[label distance = -3mm]160:$f$}] at
            (6.00, 10.00) {\textbullet};
        \node[label={[label distance = -3mm]160:$g$}] at
            (6.00, -2.00) {\textbullet};
        % d cone
        \draw (9.00, -1.00) -- (15.00, -4.46);
        \draw (9.00, -1.00) -- (15.00, 2.46);
        % b cone
        \draw (8.00, 3.00) -- (11.96, 0.71);
        \draw (8.00, 3.00) -- (15.00, 7.04);
        % c cone
        \draw (7.00, 1.00) -- (9.73, -0.58);
        \draw (7.00, 1.00) -- (9.23, 2.29);
        % f cone
        \draw (6.00, 10.00) -- (13.06, 5.92);
        \draw (6.00, 10.00) -- (15.00, 15.20);
        % g cone
        \draw (6.00, -2.00) -- (15.00, -7.20);
        \draw (6.00, -2.00) -- (9.10, -0.21);
        % a cone
        \draw (6.00, 5.00) -- (8.73, 3.42);
        \draw (6.00, 5.00) -- (10.33, 7.50);
        % e cone
        \draw (5.00, 8.00) -- (8.10, 6.21);
        \draw (5.00, 8.00) -- (7.23, 9.29);
        % q cone
        \draw[line width = 0.5mm] (3.00, 5.00) -- (8.46, 1.85);
        \draw[line width = 0.5mm] (3.00, 5.00) -- (6.60, 7.08);
        % p cone
        \draw[line width = 0.5mm] (2.00, 2.00) -- (7.46, -1.15);
        \draw[line width = 0.5mm] (2.00, 2.00) -- (5.10, 3.79);

        \draw[dashed] (2, -3) -- (2, 8);
        \draw[dashed] (3, 3) -- (3, 8);

        \node at (18, 5) {$ \leftrightarrow$};

        \node[label={[label distance = -3mm]160:$p$}] at
            (23.00, 2.00) {\textbullet};
        \node[label={[label distance = -3mm]160:$q$}] at
            (22.00, 5.00) {\textbullet};
        \node[label={[label distance = -2mm]90:$a = w$}] at
            (26.00, 5.00) {\textbullet};
        \node[label={[label distance = -3mm]160:$b$}] at
            (28.00, 3.00) {\textbullet};
        \node[label={[label distance = -1mm]90:$c = t$}] at
            (27.00, 1.00) {\textbullet};
        \node[label={[label distance = -3mm]160:$d$}] at
            (29.00, -1.00) {\textbullet};
        \node[label={[label distance = -3mm]160:$e$}] at
            (25.00, 8.00) {\textbullet};
        \node[label={[label distance = -3mm]160:$f$}] at
            (26.00, 10.00) {\textbullet};
        \node[label={[label distance = -3mm]160:$g$}] at
            (26.00, -2.00) {\textbullet};
        % d cone
        \draw (29.00, -1.00) -- (35.00, -4.46);
        \draw (29.00, -1.00) -- (35.00, 2.46);
        % b cone
        \draw (28.00, 3.00) -- (31.96, 0.71);
        \draw (28.00, 3.00) -- (35.00, 7.04);
        % c cone
        \draw (27.00, 1.00) -- (29.73, -0.58);
        \draw (27.00, 1.00) -- (29.23, 2.29);
        % f cone
        \draw (26.00, 10.00) -- (33.06, 5.92);
        \draw (26.00, 10.00) -- (35.00, 15.20);
        % g cone
        \draw (26.00, -2.00) -- (35.00, -7.20);
        \draw (26.00, -2.00) -- (29.10, -0.21);
        % a cone
        \draw (26.00, 5.00) -- (28.73, 3.42);
        \draw (26.00, 5.00) -- (30.33, 7.50);
        % e cone
        \draw (25.00, 8.00) -- (28.10, 6.21);
        \draw (25.00, 8.00) -- (27.23, 9.29);
        % p cone
        \draw[line width = 0.5mm] (23.00, 2.00) -- (27.96, -0.87);
        \draw[line width = 0.5mm] (23.00, 2.00) -- (27.10, 4.37);
        % q cone
        \draw[line width = 0.5mm] (22.00, 5.00) -- (25.10, 3.21);
        \draw[line width = 0.5mm] (22.00, 5.00) -- (26.10, 7.37);

        \draw[dashed] (22, -3) -- (22, 8);
        \draw[dashed] (23, -1) -- (23, 4);
    \end{tikzpicture}
    \caption{Da esquerda para direita, o caso em que
    $p$ está em $\Hits_{up}(q)$. Da direita para esquerda,
    o caso em que $q$ está em $Hits_{low}(p)$.}
    \label{fig:parcinetico:eventohorizontalabaixo}
\end{figure}
Se $p$ está em $\Hits_{up}(q)$, como demonstrado na figura
\ref{fig:parcinetico:eventohorizontalabaixo}, então parte de
$\Cands(q)$ terá de passar para $\Cands(p)$. Para tal, buscamos pelo
novo $t = \up(p)$ em $\Cands(q)$ e chamamos a rotina \textit{splay}
para o nó que contém $t$. Após o \textit{splay}, chamamos um
\textit{split} na subárvore esquerda desse nó e unimos ela a
$\Cands(p)$. Se $t$ não for encontrado em $\Cands(q)$, então $t =
\up(q)$ e todos os pontos de $\Cands(q)$ devem ser transferidos para
$\Cands(p)$. Não podemos esquecer de remover $p$ de $\Hits_{up}(q)$
e adicioná-lo em $\Hits_{up}(t)$, além de remover $q$ de
$\Hits_{low}(w)$ e adicioná-lo em $\Hits_{low}(p)$. Se $p$ não está
em $\Hits_{up}(q)$, então não haverão mudanças, veja a figura
\ref{fig:parcinetico:eventohorizontalabaixosemmudancas}.

\begin{figure}[h]
    \centering
    \begin{tikzpicture}[thick, scale=0.4]
        \node[label={[label distance = -3mm]160:$p$}] at
            (0.00, 2.00) {\textbullet};
        \node[label={[label distance = -3mm]160:$e$}] at
            (3.00, 5.00) {\textbullet};
        \node[label={[label distance = -3mm]160:$a$}] at
            (6.00, 5.00) {\textbullet};
        \node[label={[label distance = -3mm]160:$b$}] at
            (8.00, 3.00) {\textbullet};
        \node[label={[label distance = -3mm]160:$c$}] at
            (7.00, 1.00) {\textbullet};
        \node[label={[label distance = -3mm]160:$d$}] at
            (9.00, -1.00) {\textbullet};
        \node[label={[label distance = -3mm]160:$q$}] at
            (1.00, 8.00) {\textbullet};
        \node[label={[label distance = -3mm]220:$f$}] at
            (6.00, -2.00) {\textbullet};

        % d cone
        \draw (9.00, -1.00) -- (15.00, -4.46);
        \draw (9.00, -1.00) -- (15.00, 2.46);
        % b cone
        \draw (8.00, 3.00) -- (11.96, 0.71);
        \draw (8.00, 3.00) -- (15.00, 7.04);
        % c cone
        \draw (7.00, 1.00) -- (9.73, -0.58);
        \draw (7.00, 1.00) -- (9.23, 2.29);
        % f cone
        \draw (6.00, -2.00) -- (15.00, -7.20);
        \draw (6.00, -2.00) -- (9.10, -0.21);
        % a cone
        \draw (6.00, 5.00) -- (8.73, 3.42);
        \draw (6.00, 5.00) -- (15.00, 10.20);
        % e cone
        \draw (3.00, 5.00) -- (8.46, 1.85);
        \draw (3.00, 5.00) -- (15.00, 11.93);
        % q cone
        \draw[line width = 0.5mm] (1.00, 8.00) -- (4.60, 5.92);
        \draw[line width = 0.5mm] (1.00, 8.00) -- (15.00, 16.08);
        % p cone
        \draw[line width = 0.5mm] (0.00, 2.00) -- (6.46, -1.73);
        \draw[line width = 0.5mm] (0.00, 2.00) -- (4.10, 4.37);

        \draw[dashed] (0, -1) -- (0, 7);
        \draw[dashed] (1, 3) -- (1, 9);
        \draw[dashed] (20, -1) -- (20, 7);
        \draw[dashed] (19, 3) -- (19, 9);

        \node at (16, 5) {$ \leftrightarrow$};

        \node[label={[label distance = -3mm]160:$p$}] at
            (20.00, 2.00) {\textbullet};
        \node[label={[label distance = -3mm]160:$e$}] at
            (23.00, 5.00) {\textbullet};
        \node[label={[label distance = -3mm]160:$a$}] at
            (26.00, 5.00) {\textbullet};
        \node[label={[label distance = -3mm]160:$b$}] at
            (28.00, 3.00) {\textbullet};
        \node[label={[label distance = -3mm]160:$c$}] at
            (27.00, 1.00) {\textbullet};
        \node[label={[label distance = -3mm]160:$d$}] at
            (29.00, -1.00) {\textbullet};
        \node[label={[label distance = -3mm]160:$q$}] at
            (19.00, 8.00) {\textbullet};
        \node[label={[label distance = -3mm]220:$f$}] at
            (26.00, -2.00) {\textbullet};

        % d cone
        \draw (29.00, -1.00) -- (35.00, -4.46);
        \draw (29.00, -1.00) -- (35.00, 2.46);
        % b cone
        \draw (28.00, 3.00) -- (31.96, 0.71);
        \draw (28.00, 3.00) -- (35.00, 7.04);
        % c cone
        \draw (27.00, 1.00) -- (29.73, -0.58);
        \draw (27.00, 1.00) -- (29.23, 2.29);
        % f cone
        \draw (26.00, -2.00) -- (35.00, -7.20);
        \draw (26.00, -2.00) -- (29.10, -0.21);
        % a cone
        \draw (26.00, 5.00) -- (28.73, 3.42);
        \draw (26.00, 5.00) -- (35.00, 10.20);
        % e cone
        \draw (23.00, 5.00) -- (28.46, 1.85);
        \draw (23.00, 5.00) -- (35.00, 11.93);
        % p cone
        \draw[line width = 0.5mm] (20.00, 2.00) -- (26.46, -1.73);
        \draw[line width = 0.5mm] (20.00, 2.00) -- (24.10, 4.37);
        % q cone
        \draw[line width = 0.5mm] (19.00, 8.00) -- (23.60, 5.35);
        \draw[line width = 0.5mm] (19.00, 8.00) -- (35.00, 17.24);
    \end{tikzpicture}
    \caption{Se $p$ não está em $\Hits_{up}(q)$, ou se
    $q$ não está em $\Hits_{low}(p)$, nada acontece.}
    \label{fig:parcinetico:eventohorizontalabaixosemmudancas}
\end{figure}
Similarmente, se $q$ está em $\Hits_{low}(p)$, como demonstrado na
figura \ref{fig:parcinetico:eventohorizontalabaixo}, parte de
$\Cands(p)$ passará para $\Cands(q)$. Para realizar tal operação,
buscamos pelo novo $t = low(q)$ em $Cands(p)$, damos um
\textit{splay} no nó que o contém, separamos a subárvore direita
desse nó e unimos ela à $Cands(q)$. Se $t$ não for encontrado em
$Cands(p)$, então $t = low(p)$ e todos os pontos de $Cands(p)$ devem
ser passados para $Cands(q)$. Devemos também remover $q$ de
$Hits_{low}(p)$ e inseri-lo em $Hits_{low}(t)$, além de remover $p$
de $Hits_{up}(w)$ e adicioná-lo em $Hits_{up}(q)$. Se $q$ não está
em $Hits_{low}(p)$, então não haverão mudanças, veja a figura
\ref{fig:parcinetico:eventohorizontalabaixosemmudancas}.

\begin{algorithm}[h]
    \caption{Função \textsc{horizontalEvent}.}
    \label{parcinetico:eventohorizontal}
\begin{algorithmic}[1]
    \Function{horizontalEvent}{$p,q, dir$}
        \If{$q = \Call{owner}{p.hitsUp(dir)}$}
            \State $t \leftarrow$ \Call{predecessor}{$p, \Cands(q, dir), U$}
            \If{$t = \Null$}
                \State $t \leftarrow$ \Call{owner}{$q.hitsUp(dir)$}
            \EndIf
            \State $newCands \leftarrow$ \Call{split}{$\Null, t, Cands(q,
            dir)$}
            \State \Call{join}{$Cands(p, dir), newCands$}
            \State \Call{delete}{$p, \Hits_{up}(q, dir)$}
            \If{$t \neq \Null$}
                \State \Call{insert}{$p, \Hits_{up}(t, dir)$}
            \EndIf

            \State $w \leftarrow \Call{owner}{q.hitsLow(dir)}$

            \If{$w \neq \Null$}
                \State \Call{delete}{$q, \Hits_{low}(w, dir)$}
            \EndIf

            \State \Call{insert}{$q, \Hits_{low}(p, dir)$}
        \Else
            \If{$p = \Call{owner}{q.hitsLow(p, dir)}$}
                \State $t \leftarrow$ \Call{predecessor}{$q, \Cands(p, dir), D$}
                \If{$t = \Null$}
                    \State $t \leftarrow$ \Call{owner}{$p.hitsLow(dir)$}
                \EndIf
                \State $newCands \leftarrow \Call{split}{t, \Null, Cands(p,
                dir)}$
                \State \Call{join}{$Cands(q, dir), newCands$}
                \State \Call{delete}{$q, \Hits_{low}(p, dir)$}
                \If{$t \neq \Null$}
                    \State \Call{insert}{$q, \Hits_{low}(t, dir)$}
                \EndIf
                \State $w \leftarrow \Call{owner}{p.hitsUp(dir)}$
                \If{$w \neq \Null$}
                    \State \Call{delete}{$p, \Hits_{up}(w, dir)$}
                \EndIf
                \State \Call{insert}{$p, Hits_{up}(q, dir)$}
            \EndIf
        \EndIf
        \State $v \leftarrow \Call{owner}{p.cands(dir)}$
        \State $v' \leftarrow \Call{owner}{q.cands(dir)}$
        \If{$v = v'$}
            \State \Call{updateLcand}{$v, dir$}
        \EndIf
    \EndFunction
\end{algorithmic}
\end{algorithm}

No caso de um evento em que ocorre uma mudança na $60^\circ$-ordem,
que é a ordem dos pontos projetados no eixo $x + 60^\circ$, vamos
assumir que $p$ é o ponto que está à esquerda e acima de $q$. O
evento pode provocar a entrada ou saída do ponto $q$ de $\Cands(p)$,
veja a figura \ref{fig:parcinetico:eventoup}. O algoritmo
\ref{parcinetico:eventoup} implementa a sequência de operações
referentes a este evento.

Se $p$ está em $\Hits_{low}(q)$, ou seja, $q$ está entrando em
$\Dom(p)$ como demonstrado na figura \ref{fig:parcinetico:eventoup}
da esquerda para direita, então a troca na $60^\circ$-ordem afetará
o ponto $v$ tal que $q$ está em $\Cands(v)$. Achamos esse ponto
subindo em $\Cands(v)$, a partir do nó que contém $q$, até a raiz
que aponta para $v$. Devemos então remover $q$ de $\Cands(v)$ e
inseri-lo em $\Cands(p)$. A mudança também afetará todos os pontos
que estão à esquerda de $p$ e estão em $\Hits_{up}(q)$. Para achar
esses pontos, buscamos o ponto $t$ em $\Hits_{up}(q)$ mais à
esquerda que está à direita de $p$. Chamamos \textit{splay} para o
nó que contém $t$ e chamamos \textit{split} para a subárvore
esquerda desse nó e juntamos essa árvore em $\Hits_{up}(p)$, pois
são todos os pontos à esquerda de $p$ que tinham $q$ como $\up$ e
agora seu novo $\up$ é $p$. Se esse ponto $t$ não existe, todos os
pontos de $\Hits_{up}(q)$ devem ser transferidos para
$\Hits_{up}(p)$, veja a figura
\ref{fig:parcinetico:eventouptnaoexiste}, e buscamos pelo ponto $t$
tal que $q$ está em $\Hits_{low}(t)$. Por fim, removemos o ponto $p$
de $\Hits_{low}(q)$ e o inserimos em $\Hits_{low}(t)$. Se $p$ não
está em $\Hits_{low}(q)$ não haverão mudanças.

Se $q$ está em $\Cands(p)$, ou seja, $q$ está saindo de $\Dom(p)$
como demonstrado na figura~ \ref{fig:parcinetico:eventoup} da
direita para esquerda, então a troca afetará o ponto $t$ tal que $p$
está em $\Hits_{low}(t)$. Se o ponto $t$ existe, removemos $p$ de
$\Hits_{low}(t)$. Devemos agora inserir $p$ em $\Hits_{low}(q)$, já
que $q$ é o novo $\low(p)$. A mudança também afetará os pontos de
$\Hits_{up}(p)$ que agora deverão estar em $\Hits_{up}(q)$. Para
achar esses pontos, buscamos pelo ponto $v$ em $\Hits_{up}(p)$ mais
à direita que não deveria estar em $\Hits_{up}(q)$, chamamos
\textit{splay} para o nó que contém $v$ e um \textit{split} para sua
subárvore direita, essa nova árvore deve ser incorporada a
$\Hits_{up}(q)$. Se tal ponto $v$ não existe, todos os nós de
$\Hits_{up}(p)$ devem ser passados para $\Hits_{up}(q)$. Por fim,
devemos achar o novo ponto $u$ tal que $q$ deve estar em
$\Cands(u)$. Se o ponto $v$ descrito anteriormente existe, então $u
= v$. Se $v$ não existe, então $u$ é o ponto tal que $p$ está em
$\Cands(u)$. Dessa forma, retiramos $q$ de $\Cands(p)$ e o inserimos
em $\Cands(u)$. Se $q$ não está em $\Cands(p)$, não haverão
mudanças.
\begin{algorithm}[h]
    \caption{Função \textsc{upEvent}.}
    \label{parcinetico:eventoup}
\begin{algorithmic}[1]
    \Function{upEvent}{$p, q, dir$}
        \If{$q = \Call{owner}{p.hitsLow(dir)}$}
            \State $v \leftarrow \Call{owner}{q.cands(dir)}$
            \If{$v \neq \Null$}
                \State \Call{delete}{$q, Cands(v, dir)$}
            \EndIf
            \State \Call{insert}{$q, Cands(p, dir)$}
            \State $t \leftarrow \Call{successor}{p, \Hits_{up}(q, dir), H}$
            \If{$t = \Null$}
                \State $t \leftarrow \Call{owner}{q.hitsLow(dir)}$
            \EndIf
            \State $newHits \leftarrow \Call{split}{\Null, t, \Hits_{up}(q, dir)}$
            \State $\Call{join}{\Hits_{up}(p, dir), newHits}$
            \State $\Call{delete}{p, \Hits_{low}(q, dir)}$
            \If{$t \neq \Null$}
                \State \Call{insert}{$p, \Hits_{low}(t, dir)$}
            \EndIf
        \Else
            \If{$p = \Call{owner}{q.cands(dir)}$}
                \State $t \leftarrow \Call{owner}{p.hitsLow(dir)}$
                \If{$t \neq \Null$}
                    \State \Call{delete}{$p, \Hits_{low}(t, dir)$}
                \EndIf
                \State $\Call{insert}{p, \Hits_{low}(q, dir)}$
                \State $v \leftarrow \Call{predecessor}{q, \Hits_{up}(p, dir), U}$
                \If{$v = \Null$}
                    \State $v \leftarrow \Call{owner}{p.cands(dir)}$
                \EndIf
                \State $newHits \leftarrow \Call{split}{v, \Null, \Hits_{up}(p,dir)}$
                \State $\Call{join}{newHits, \Hits_{up}(q, dir)}$
                \State \Call{delete}{$q, Cands(p, dir)$}
                \If{$v \neq \Null$}
                    \State \Call{insert}{$q, Cands(v, dir)$}
                \EndIf
            \EndIf
        \EndIf
    \EndFunction
\end{algorithmic}
\end{algorithm}
\begin{figure}[h]
    \centering
    \begin{tikzpicture}[thick, scale=0.4]
        \node[label={[label distance = -3mm]160:$p$}] at
            (2.00, 4.00) {\textbullet};
        \node[label={[label distance = -3mm]160:$q$}] at
            (6.00, 1.00) {\textbullet};
        \node[label={[label distance = -2mm]270:$a = t$}] at
            (5.25, -2.00) {\textbullet};
        % \node[label={[label distance = -3mm]160:$b$}] at (-5.00, 0.00) {\textbullet};
        \node[label={[label distance = -3mm]160:$c$}] at
            (-1.00, -4.00) {\textbullet};
        \node[label={[label distance = -1mm]0:$b = v$}] at
            (-2.00, 0.00) {\textbullet};
        \node[label={[label distance = -1mm]0:$e$}] at
            (0.50, -4.00) {\textbullet};

        % q cone
        \draw[line width = 0.5mm] (6.00, 1.00) -- (10.00, -1.31);
        \draw[line width = 0.5mm] (6.00, 1.00) -- (10.00, 3.31);
        % a cone
        \draw (5.25, -2.00) -- (10.00, -4.74);
        \draw (5.25, -2.00) -- (8.22, -0.28);
        % p cone
        \draw[line width = 0.5mm] (2.00, 4.00) -- (6.60, 1.35);
        \draw[line width = 0.5mm] (2.00, 4.00) -- (10.00, 8.62);
        % c cone
        \draw (-1.00, -4.00) -- (10.00, -10.35);
        \draw (-1.00, -4.00) -- (6.83, 0.52);
        % e cone
        \draw (0.50, -4.00) -- (10.00, -9.48);
        \draw (0.50, -4.00) -- (7.58, 0.09);
        % b cone
        \draw (-2.00, 0.00) -- (1.96, -2.29);
        \draw (-2.00, 0.00) -- (3.46, 3.15);
        % b cone
        % \draw (-5.00, 0.00) -- (0.46, -3.15);
        % \draw (-5.00, 0.00) -- (10.00, 8.66);

        \draw[dashed] (2.00, 4.00) -- (-1.00, 5.73);
        \draw[dashed] (6.00, 1.00) -- (2.00, 3.30);
        \node at (12, 0) {$ \leftrightarrow$};

        \node[label={[label distance = -3mm]160:$p$}] at
            (22.00, 4.00) {\textbullet};
        \node[label={[label distance = -3mm]160:$q$}] at
            (27.00, 2.00) {\textbullet};
        \node[label={[label distance = -2mm]270:$a = t$}] at
            (25.25, -2.00) {\textbullet};
        % \node[label={[label distance = -3mm]160:$b$}] at (15.00, 0.00) {\textbullet};
        \node[label={[label distance = -3mm]160:$c$}] at
            (19.00, -4.00) {\textbullet};
        \node[label={[label distance = -1mm]0:$b = v$}] at
            (18.00, 0.00) {\textbullet};
        \node[label={[label distance = -1mm]0:$e$}] at
            (20.50, -4.00) {\textbullet};

        % q cone
        \draw[line width = 0.5mm] (27.00, 2.00) -- (30.00, 0.27);
        \draw[line width = 0.5mm] (27.00, 2.00) -- (30.00, 3.73);
        % a cone
        \draw (25.25, -2.00) -- (30.00, -4.74);
        \draw (25.25, -2.00) -- (29.59, 0.51);
        % p cone
        \draw[line width = 0.5mm] (22.00, 4.00) -- (28.82, 0.06);
        \draw[line width = 0.5mm] (22.00, 4.00) -- (30.00, 8.62);
        % e cone
        \draw (20.50, -4.00) -- (30.00, -9.48);
        \draw (20.50, -4.00) -- (28.18, 0.43);
        % c cone
        \draw (19.00, -4.00) -- (30.00, -10.35);
        \draw (19.00, -4.00) -- (27.43, 0.87);
        % b cone
        \draw (18.00, 0.00) -- (21.96, -2.29);
        \draw (18.00, 0.00) -- (23.46, 3.15);
        % b cone
        % \draw (15.00, 0.00) -- (20.46, -3.15);
        % \draw (15.00, 0.00) -- (30.00, 8.66);

        \draw[dashed] (22.00, 4.00) -- (19.00, 5.73);
        \draw[dashed] (27.00, 2.00) -- (22.00, 4.88);
    \end{tikzpicture}
    \caption{Da esquerda para direita, o caso em que $p$ está em
    $\Hits_{low}(q)$, ou seja, $q$ está entrando em $Dom(p)$. Da direita
    para esquerda, o caso em que $q$ está em $Cands(p)$, saindo de
    $Dom(p)$.}
    \label{fig:parcinetico:eventoup}
\end{figure}

\begin{figure}[h]
    \centering
    \begin{tikzpicture}[thick, scale=0.4]
        \node[label={[label distance = -3mm]160:$p$}] at
            (2.00, 4.00) {\textbullet};
        \node[label={[label distance = -3mm]160:$q$}] at
            (6.00, 1.00) {\textbullet};
        \node[label={[label distance = -2mm]270:$a = t$}] at
            (7.25, -2.00) {\textbullet};
        \node[label={[label distance = -3mm]160:$c$}] at
            (-1.00, -4.00) {\textbullet};
        \node[label={[label distance = -1mm]0:$b = v$}] at
            (-2.00, 0.00) {\textbullet};
        \node[label={[label distance = -1mm]0:$e$}] at
            (0.50, -4.00) {\textbullet};

        % a cone
        \draw (7.25, -2.00) -- (10.00, -3.59);
        \draw (7.25, -2.00) -- (10.00, -0.41);
        % q cone
        \draw[line width = 0.5mm] (6.00, 1.00) -- (9.22, -0.86);
        \draw[line width = 0.5mm] (6.00, 1.00) -- (10.00, 3.31);
        % p cone
        \draw[line width = 0.5mm] (2.00, 4.00) -- (6.60, 1.35);
        \draw[line width = 0.5mm] (2.00, 4.00) -- (10.00, 8.62);
        % e cone
        \draw (0.50, -4.00) -- (10.00, -9.48);
        \draw (0.50, -4.00) -- (7.58, 0.09);
        % c cone
        \draw (-1.00, -4.00) -- (10.00, -10.35);
        \draw (-1.00, -4.00) -- (6.83, 0.52);
        % b cone
        \draw (-2.00, 0.00) -- (1.96, -2.29);
        \draw (-2.00, 0.00) -- (3.46, 3.15);


        \draw[dashed] (2.00, 4.00) -- (-1.00, 5.73);
        \draw[dashed] (6.00, 1.00) -- (2.00, 3.30);
        \node at (12, 0) {$ \leftrightarrow$};

        \node[label={[label distance = -3mm]160:$p$}] at
            (22.00, 4.00) {\textbullet};
        \node[label={[label distance = -3mm]160:$q$}] at
            (27.00, 2.00) {\textbullet};
        \node[label={[label distance = -2mm]270:$a = t$}] at
            (27.25, -2.00) {\textbullet};
        \node[label={[label distance = -3mm]160:$c$}] at
            (19.00, -4.00) {\textbullet};
        \node[label={[label distance = -1mm]0:$b = v$}] at
            (18.00, 0.00) {\textbullet};
        \node[label={[label distance = -1mm]0:$e$}] at
            (20.50, -4.00) {\textbullet};

        % a cone
        \draw (27.25, -2.00) -- (31.00, -4.17);
        \draw (27.25, -2.00) -- (31.00, 0.17);
        % q cone
        \draw[line width = 0.5mm] (27.00, 2.00) -- (30.59, -0.07);
        \draw[line width = 0.5mm] (27.00, 2.00) -- (31.00, 4.31);
        % p cone
        \draw[line width = 0.5mm] (22.00, 4.00) -- (29.82, -0.52);
        \draw[line width = 0.5mm] (22.00, 4.00) -- (31.00, 9.20);
        % e cone
        \draw (20.50, -4.00) -- (31.00, -10.06);
        \draw (20.50, -4.00) -- (28.18, 0.43);
        % c cone
        \draw (19.00, -4.00) -- (31.00, -10.93);
        \draw (19.00, -4.00) -- (27.43, 0.87);
        % b cone
        \draw (18.00, 0.00) -- (21.96, -2.29);
        \draw (18.00, 0.00) -- (23.46, 3.15);

        \draw[dashed] (22.00, 4.00) -- (19.00, 5.73);
        \draw[dashed] (27.00, 2.00) -- (22.00, 4.88);
    \end{tikzpicture}
    \caption{Da esquerda para a direita,
    todos os pontos de $\Hits_{up}(q)$
    são transferidos para $\Hits_{up}(p)$
    e $p$, que está em $\Hits_{low}(q)$,
    é transferido para $\Hits_{low}(t)$.
    Da direita para esquerda, os pontos
    em $\Hits_{up}(p)$ são transferidos
    para $\Hits_{up}(q)$ e $p$, que está
    em $\Hits_{low}(t)$, é transferido
    para $\Hits_{low}(q)$.}
    \label{fig:parcinetico:eventouptnaoexiste}
\end{figure}
Um evento em que ocorre uma mudança na $-60^\circ$-ordem, a ordem
dos pontos projetados no eixo $x - 60^\circ$, é simétrico a um
evento na $60^\circ$-ordem. Os pontos envolvidos no evento serão $p$
e $q$ e vamos assumir que $p$ é o ponto mais à esquerda e abaixo de
$q$. O evento pode provocar a entrada ou saída do ponto $q$ de
$Cands(p)$, veja a figura \ref{fig:parcinetico:eventodown}. O
algoritmo \ref{fig:parcinetico:eventodown} implementa a sequência de
operações referentes a esse evento.

Se $p$ está em $\Hits_{up}(q)$ ($q$ está entrando em $Dom(p)$), como
demonstrado na figura \ref{fig:parcinetico:eventodown}, então a
troca na $-60^\circ$-ordem afetará o ponto $v$ tal que $q$ está em
$Cands(v)$. Achamos esse ponto subindo em $Cands(v)$, a partir do nó
que contém $q$, até a raiz que aponta para~$v$. Devemos então
remover $q$ de $Cands(v)$ e inseri-lo em $Cands(p)$. A mudança
também afetará todos os pontos que estão à esquerda de $p$ e estão
em $\Hits_{low}(q)$. Para achar esses pontos buscamos o ponto $t$ em
$\Hits_{low}(q)$ mais à esquerda que está a direita de $p$. Chamamos
\textit{splay} para o nó que contém $t$ e \textit{split} para a nova
subárvore esquerda desse nó e juntamos essa árvore em
$\Hits_{low}(p)$, pois são todos pontos à esquerda de $p$ que tinham
$q$ como $low$ e agora seu novo $low$ é $p$. Se esse ponto $t$ não
existe, veja a figura \ref{fig:parcinetico:eventodowntnaoexiste},
então buscamos pelo ponto $t$ tal que $q$ está em $\Hits_{up}(t)$.
Por fim, removemos o ponto $p$ de $\Hits_{up}(q)$ e o inserimos em
$\Hits_{up}(t)$. Se $p$ não está em $\Hits_{up}(q)$ não haverão
mudanças.

Se $q$ está em $Cands(p)$ ($q$ está saindo de $Dom(p)$), como
demonstrado na figura \ref{fig:parcinetico:eventodown}, então a
troca afetará o ponto $t$ tal que $p$ está em $\Hits_{up}(t)$. Se o
ponto $t$ existe, removemos $p$ de $\Hits_{up}(t)$. Devemos agora
inserir $p$ em $\Hits_{up}(q)$, já que $q$ é o novo $up(p)$. A
mudança também afetará os pontos de $\Hits_{low}(p)$ que agora
atingem $Dom(q)$. Para achar esses pontos, buscamos pelo ponto $v$
em $\Hits_{low}(p)$ mais à direita que não atinge $Dom(q)$, chamamos
\textit{splay} para o nó que contém $v$ e um \textit{split} para sua
subárvore direita. Essa nova árvore deve ser incorporada a
$\Hits_{low}(q)$. Se tal ponto $v$ não existe, todos os nós de
$\Hits_{low}(p)$ devem ser passados para $\Hits_{low}(q)$. Por fim,
devemos achar o novo ponto~$u$ tal que $q$ deve estar em $Cands(u)$.
Se o ponto $v$ descrito anteriormente existe, então~$u = v$. Se $v$
não existe, então $u$ é o ponto tal que $p$ está em $Cands(u)$.
Dessa forma, retiramos $q$ de $Cands(p)$ e o inserimos em
$Cands(u)$. Se $q$ não está em $Cands(p)$, não haverão mudanças.
\begin{algorithm}[h]
    \caption{Função downEvent.} \label{par:eventodown}
\begin{algorithmic}[1]
    \Function{downEvent}{$p, q, dir$}
        \If{$q = \Call{owner}{p.hitsUp(dir)}$}
            \State $v \leftarrow \Call{owner}{q.cands(dir)}$
            \If{$v \neq \Null$}
                \State \Call{delete}{$q, Cands(v, dir)$}
            \EndIf
            \State \Call{insert}{$q, Cands(p, dir)$}
            \State $t \leftarrow \Call{successor}{p, \Hits_{low}(q, dir), H}$
            \If{$t = \Null$}
                \State $t \leftarrow \Call{owner}{q.hitsUp(dir)}$
            \EndIf
            \State $newHits \leftarrow \Call{split}{\Null, t, \Hits_{low}(q, dir)}$
            \State $\Call{join}{\Hits_{low}(p, dir), newHits}$
            \State $\Call{delete}{p, \Hits_{up}(q, dir)}$
            \If{$t \neq \Null$}
                \State \Call{insert}{$p, \Hits_{up}(t, dir)$}
            \EndIf
        \Else
            \If{$p = \Call{owner}{q.cands(dir)}$}
                \State $t \leftarrow \Call{owner}{p.hitsUp(dir)}$
                \If{$t \neq \Null$}
                    \State \Call{delete}{$p, \Hits_{up}(t, dir)$}
                \EndIf
                \State $\Call{insert}{p, \Hits_{up}(q, dir)}$
                \State $v \leftarrow \Call{predecessor}{q, \Hits_{low}(p, dir), D}$
                \If{$v = \Null$}
                    \State $v \leftarrow \Call{owner}{p.cands(dir)}$
                \EndIf
                \State $newHits \leftarrow \Call{split}{v, \Null, \Hits_{low}(p,dir)}$
                \State $\Call{join}{newHits, \Hits_{low}(q, dir)}$
                \State \Call{delete}{$q, Cands(p, dir)$}
                \If{$v \neq \Null$}
                    \State \Call{insert}{$q, Cands(v, dir)$}
                \EndIf
            \EndIf
        \EndIf
    \EndFunction
\end{algorithmic}
\end{algorithm}
\begin{figure}[h]
    \centering
    \begin{tikzpicture}[thick, scale=0.4]
        \node[label={[label distance = -3mm]160:$p$}] at
            (6.00, 0.00) {\textbullet};
        \node[label={[label distance = -3mm]160:$q$}] at
            (8.00, 2.00) {\textbullet};
        \node[label={[label distance = -1mm]180:$a$}] at
            (0.00, 5.00) {\textbullet};
        \node[label={[label distance = -2mm]90:$b = v$}] at
            (2.00, 5.00) {\textbullet};
        \node[label={[label distance = 0mm]0:$c$}] at
            (4.00, 5.00) {\textbullet};
        \node[label={[label distance = 0mm]0:$d$}] at
            (10.00, 4.00) {\textbullet};
        \node[label={[label distance = 0mm]90:$e = t$}] at
            (8.00, 4.00) {\textbullet};

        % d cone
        \draw (10.00, 4.00) -- (14.00, 1.69);
        \draw (10.00, 4.00) -- (14.00, 6.31);
        % q cone
        \draw[dashed] (8.00, 2.00) -- (4.00, -0.30);
        \draw[line width = 0.5mm] (8.00, 2.00) -- (14.00, -1.46);
        \draw[line width = 0.5mm] (8.00, 2.00) -- (10.73, 3.58);
        % e cone
        \draw (8.00, 4.00) -- (9.73, 3.00);
        \draw (8.00, 4.00) -- (14.00, 7.46);
        % p cone
        \draw[dashed] (6.00, 0.00) -- (2.00, -2.30);
        \draw[line width = 0.5mm] (6.00, 0.00) -- (14.00, -4.62);
        \draw[line width = 0.5mm] (6.00, 0.00) -- (8.73, 1.58);
        % c cone
        \draw (4.00, 5.00) -- (8.60, 2.35);
        \draw (4.00, 5.00) -- (14.00, 10.77);
        % b cone
        \draw (2.00, 5.00) -- (8.33, 1.35);
        \draw (2.00, 5.00) -- (14.00, 11.93);
        % a cone
        \draw (0.00, 5.00) -- (7.33, 0.77);
        \draw (0.00, 5.00) -- (14.00, 13.08);

        \node at (17, 5) {$ \leftrightarrow$};

        \node[label={[label distance = -3mm]160:$p$}] at
            (26.00, 0.00) {\textbullet};
        \node[label={[label distance = -3mm]160:$q$}] at
            (29.00, 1.00) {\textbullet};
        \node[label={[label distance = -1mm]180:$a$}] at
            (20.00, 5.00) {\textbullet};
        \node[label={[label distance = -2mm]90:$b = v$}] at
            (22.00, 5.00) {\textbullet};
        \node[label={[label distance = 0mm]0:$c$}] at
            (24.00, 5.00) {\textbullet};
        \node[label={[label distance = 0mm]0:$d$}] at
            (30.00, 4.00) {\textbullet};
        \node[label={[label distance = 0mm]90:$e = t$}] at
            (28.00, 4.00) {\textbullet};

        % d cone
        \draw (30.00, 4.00) -- (35.00, 1.11);
        \draw (30.00, 4.00) -- (35.00, 6.89);
        % q cone
        \draw[dashed] (29.00, 1.00) -- (26.00, -0.73);
        \draw[line width = 0.5mm] (29.00, 1.00) -- (35.00, -2.46);
        \draw[line width = 0.5mm] (29.00, 1.00) -- (32.10, 2.79);
        % e cone
        \draw (28.00, 4.00) -- (31.10, 2.21);
        \draw (28.00, 4.00) -- (34.00, 7.46);
        % p cone
        \draw[dashed] (26.00, 0.00) -- (24.00, -1.15);
        \draw[line width = 0.5mm] (26.00, 0.00) -- (35.00, -5.20);
        \draw[line width = 0.5mm] (26.00, 0.00) -- (30.46, 2.58);
        % c cone
        \draw (24.00, 5.00) -- (29.33, 1.92);
        \draw (24.00, 5.00) -- (35.00, 11.35);
        % b cone
        \draw (22.00, 5.00) -- (28.33, 1.35);
        \draw (22.00, 5.00) -- (35.00, 12.51);
        % a cone
        \draw (20.00, 5.00) -- (27.33, 0.77);
        \draw (20.00, 5.00) -- (35.00, 13.66);
    \end{tikzpicture}
    \caption{Da esquerda para direita, o caso em que
    $p$ está em $\Hits_{up}(q)$, ou seja, $q$ está
    entrando em $\Dom(p)$. Da direita para esquerda,
    o caso em que $q$ está em $\Cands(p)$, saindo
    de $\Dom(p)$.}
    \label{fig:parcinetico:eventodown}
\end{figure}
\begin{figure}[h]
    \centering
    \begin{tikzpicture}[thick, scale=0.4]
        \node[label={[label distance = -3mm]160:$p$}] at
            (6.00, 0.00) {\textbullet};
        \node[label={[label distance = -3mm]160:$q$}] at
            (8.00, 2.00) {\textbullet};
        \node[label={[label distance = -3mm]160:$a$}] at
            (0.00, 5.00) {\textbullet};
        \node[label={[label distance = -3mm]160:$b$}] at
            (2.00, 5.00) {\textbullet};
        \node[label={[label distance = -3mm]160:$c$}] at
            (4.00, 5.00) {\textbullet};
        \node[label={[label distance = -3mm]160:$d = t$}] at
            (10.00, 4.00) {\textbullet};

        % d cone
        \draw (10.00, 4.00) -- (15.00, 1.11);
        \draw (10.00, 4.00) -- (15.00, 6.89);
        % q cone
        \draw[dashed] (8.00, 2.00) -- (4.00, -0.30);
        \draw[line width = 0.5mm] (8.00, 2.00) -- (15.00, -2.04);
        \draw[line width = 0.5mm] (8.00, 2.00) -- (10.73, 3.58);
        % p cone
        \draw[dashed] (6.00, 0.00) -- (2.00, -2.30);
        \draw[line width = 0.5mm] (6.00, 0.00) -- (15.00, -5.20);
        \draw[line width = 0.5mm] (6.00, 0.00) -- (8.73, 1.58);
        % c cone
        \draw (4.00, 5.00) -- (8.60, 2.35);
        \draw (4.00, 5.00) -- (15.00, 11.35);
        % b cone
        \draw (2.00, 5.00) -- (8.33, 1.35);
        \draw (2.00, 5.00) -- (15.00, 12.51);
        % a cone
        \draw (0.00, 5.00) -- (7.33, 0.77);
        \draw (0.00, 5.00) -- (15.00, 13.66);

        \node at (17, 5) {$ \leftrightarrow$};

        \node[label={[label distance = -3mm]160:$p$}] at
            (26.00, 0.00) {\textbullet};
        \node[label={[label distance = -3mm]160:$q$}] at
            (29.00, 1.00) {\textbullet};
        \node[label={[label distance = -3mm]160:$a$}] at
            (20.00, 5.00) {\textbullet};
        \node[label={[label distance = -3mm]160:$b$}] at
            (22.00, 5.00) {\textbullet};
        \node[label={[label distance = -3mm]160:$c$}] at
            (24.00, 5.00) {\textbullet};
        \node[label={[label distance = -3mm]160:$d = t$}] at
            (30.00, 4.00) {\textbullet};

        % d cone
        \draw (30.00, 4.00) -- (35.00, 1.11);
        \draw (30.00, 4.00) -- (35.00, 6.89);
        % q cone
        \draw[dashed] (29.00, 1.00) -- (26.00, -0.73);
        \draw[line width = 0.5mm] (29.00, 1.00) -- (35.00, -2.46);
        \draw[line width = 0.5mm] (29.00, 1.00) -- (32.10, 2.79);
        % p cone
        \draw[dashed] (26.00, 0.00) -- (24.00, -1.15);
        \draw[line width = 0.5mm] (26.00, 0.00) -- (35.00, -5.20);
        \draw[line width = 0.5mm] (26.00, 0.00) -- (31.46, 3.15);
        % c cone
        \draw (24.00, 5.00) -- (29.33, 1.92);
        \draw (24.00, 5.00) -- (35.00, 11.35);
        % b cone
        \draw (22.00, 5.00) -- (28.33, 1.35);
        \draw (22.00, 5.00) -- (35.00, 12.51);
        % a cone
        \draw (20.00, 5.00) -- (27.33, 0.77);
        \draw (20.00, 5.00) -- (35.00, 13.66);
    \end{tikzpicture}
    \caption{Da direita para esquerda, $p$, que estava em $\Hits_{up}(q)$
    foi transferido para $\Hits_{up}(t)$ e todos os elementos em
    $\Hits_{low}(q)$ foram transferidos para $\Hits_{low}(p)$. Da esquerda
    para direita, $p$, que estava em $\Hits_{up}(t)$, foi transferido para
    $\Hits_{up}(q)$ e os pontos à direita de $v$ em $\Hits_{low}(p)$ foram
    transferidos para $\Hits_{low}(q)$.}
    \label{fig:parcinetico:eventodowntnaoexiste}
\end{figure}

\input{conteudo/par/cineticodegen}